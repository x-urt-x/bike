<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ESP8266 Flash Data Viewer</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    canvas { max-width: 100%; }
  </style>
</head>
<body>
  <h1>Последние N секторов</h1>
  <label>Сколько секторов загрузить: <input type="number" id="sectorCount" value="5" min="1" max="50"></label>
  <button onclick="loadSectors()">Загрузить</button>
  <canvas id="chart"></canvas>

  <script>
    const SECTOR_SIZE = 4096;
    const DATA_SIZE = 17;
    const START_OFFSET = 4;
    const KEY = 0xDEADBEEF;

    async function loadSectors() {
      const count = parseInt(document.getElementById('sectorCount').value);
      const chartData = { labels: [], datasets: [
        { label: 'ang1', data: [], borderColor: 'red' },
        { label: 'ang2', data: [], borderColor: 'green' },
        { label: 'ang3', data: [], borderColor: 'blue' }
      ]};

      for (let i = 0; i < count; i++) {
        const response = await fetch(`/sector?i=${i}`);
        if (!response.ok) continue;
        const buffer = new Uint8Array(await response.arrayBuffer());

        const key = new DataView(buffer.buffer).getUint32(SECTOR_SIZE - 4, true);
        if (key !== KEY) continue;

        for (let j = 0; j < 240; j++) {
          const offset = START_OFFSET + j * DATA_SIZE;
          if (offset + DATA_SIZE > SECTOR_SIZE - 8) break;

          const view = new DataView(buffer.buffer, offset, DATA_SIZE);
          const cranks = view.getUint16(0, true);
          const wheel = view.getUint16(2, true);
          const pos = view.getInt8(4);
          const ang1 = view.getFloat32(5, true);
          const ang2 = view.getFloat32(9, true);
          const ang3 = view.getFloat32(13, true);

          chartData.labels.push(chartData.labels.length);
          chartData.datasets[0].data.push(ang1);
          chartData.datasets[1].data.push(ang2);
          chartData.datasets[2].data.push(ang3);
        }
      }

      const ctx = document.getElementById('chart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: chartData,
        options: {
          responsive: true,
          scales: { x: { display: true, title: { display: true, text: 'Измерение' } },
                    y: { display: true, title: { display: true, text: 'Угол' } } }
        }
      });
    }
  </script>
</body>
</html>
