<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ESP8266 Flash Sector Viewer</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    label, input, button { margin: 10px 5px; font-size: 16px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #aaa; padding: 4px 8px; text-align: center; }
    #sectorNumber { font-weight: bold; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>Flash Sector Viewer</h1>

  <label>Sector index:
    <input type="number" id="sectorInput" value="-1" min="-10000" max="10000">
  </label>
  <button onclick="loadSector()">Load Sector</button>

  <div id="sectorNumber">Sector: -</div>
  <table id="dataTable">
    <thead>
      <tr>
        <th>#</th>
        <th>Cranks</th>
        <th>Wheel</th>
        <th>Pos</th>
        <th>Ang1</th>
        <th>Ang2</th>
        <th>Ang3</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const SECTOR_SIZE = 4096;
    const ENTRY_SIZE = 17;
    const HEADER_SIZE = 4;
    const SECTOR_KEY = 0xDEADBEEF;

    async function loadSector() {
      const index = parseInt(document.getElementById("sectorInput").value);
      const response = await fetch(`/sector?i=${index}`);
      if (!response.ok) return alert("Failed to fetch sector");

      const buffer = new Uint8Array(await response.arrayBuffer());
      const view = new DataView(buffer.buffer);

      document.getElementById("sectorNumber").textContent = `Sector: ${view.getUint32(0, true)}`;

      const tbody = document.querySelector("#dataTable tbody");
      tbody.innerHTML = "";

      let entryOffset = HEADER_SIZE;
      let entryIndex = 0;

      while (entryOffset + ENTRY_SIZE <= SECTOR_SIZE - 4) {
        const marker = view.getUint32(entryOffset, true);
        if (marker === SECTOR_KEY) break;

        const cranks = view.getUint16(entryOffset, true);
        const wheel = view.getUint16(entryOffset + 2, true);
        const pos = view.getInt8(entryOffset + 4);
        const ang1 = view.getFloat32(entryOffset + 5, true);
        const ang2 = view.getFloat32(entryOffset + 9, true);
        const ang3 = view.getFloat32(entryOffset + 13, true);

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${++entryIndex}</td>
          <td>${cranks}</td>
          <td>${wheel}</td>
          <td>${pos}</td>
          <td>${ang1.toFixed(2)}</td>
          <td>${ang2.toFixed(2)}</td>
          <td>${ang3.toFixed(2)}</td>
        `;
        tbody.appendChild(row);

        entryOffset += ENTRY_SIZE;
      }

      if (entryIndex === 0) {
        const row = document.createElement("tr");
        row.innerHTML = `<td colspan="7">No valid data found.</td>`;
        tbody.appendChild(row);
      }
    }
  </script>
</body>
</html>
